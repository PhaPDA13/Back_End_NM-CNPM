generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id        Int      @id @default(autoincrement())
  fullName  String   @db.VarChar(100)
  email     String   @unique @db.VarChar(100)
  username  String   @unique @db.VarChar(100)
  password  String   @db.VarChar(255)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  agents        Agent[]
  receipts      Receipt[]
  exportNotes   ExportNote[]
  products      Product[]
  units         Unit[]
  refreshTokens RefreshToken[]
}

model Agent {
  id          Int      @id @default(autoincrement())
  name        String   @db.VarChar(45)
  phone       String   @db.VarChar(15)
  address     String   @db.VarChar(100)
  email       String   @unique @db.VarChar(45)
  debtAmount  Decimal  @default(0) @db.Decimal(15,2)
  districtId  Int
  agentTypeId Int
  ownerId     Int
  isDeleted   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  owner     User      @relation(fields: [ownerId], references: [id])
  agentType AgentType @relation(fields: [agentTypeId], references: [id])
  district  District  @relation(fields: [districtId], references: [id])

  receipts    Receipt[]
  exportNotes ExportNote[]
}

model ExportNote {
  id        Int      @id @default(autoincrement())
  issueDate DateTime @db.Date
  agentId   Int
  ownerId   Int
  total     Decimal  @default(0) @db.Decimal(15,2)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  agent Agent @relation(fields: [agentId], references: [id], onDelete: Restrict)
  owner User  @relation(fields: [ownerId], references: [id], onDelete: Restrict)

  details ExportNoteDetail[]
}

model ExportNoteDetail {
  exportNoteId Int
  productId    Int
  unitId       Int
  quantity     Int
  price        Decimal  @db.Decimal(15,2)
  amount       Decimal? @db.Decimal(15,2)

  exportNote ExportNote @relation(fields: [exportNoteId], references: [id], onDelete: Cascade)
  product    Product    @relation(fields: [productId], references: [id], onDelete: Cascade)
  unit       Unit       @relation(fields: [unitId], references: [id], onDelete: Restrict)

  @@id([exportNoteId, productId, unitId])
}

model Receipt {
  id              Int      @id @default(autoincrement())
  payDate         DateTime @db.Date
  amount          Decimal  @db.Decimal(15,2)
  remainingDebt   Decimal  @default(0) @db.Decimal(15,2)
  agentId         Int
  ownerId         Int
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  agent Agent @relation(fields: [agentId], references: [id], onDelete: Restrict)
  owner User  @relation(fields: [ownerId], references: [id], onDelete: Restrict)
}

model AgentType {
  id      Int     @id @default(autoincrement())
  name    String  @unique
  maxDebt Decimal @db.Decimal(15,2)

  agents    Agent[]
  products  AgentTypeProduct[]
}

model Product {
  id        Int     @id @default(autoincrement())
  name      String  @unique
  price     Decimal @db.Decimal(15,2)
  ownerId   Int
  isDeleted Boolean @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  owner      User               @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  details    ExportNoteDetail[]
  agentTypes AgentTypeProduct[]
  units      ProductUnit[]
}

model Unit {
  id      Int    @id @default(autoincrement())
  name    String @unique
  ownerId Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  owner    User               @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  details  ExportNoteDetail[]
  products ProductUnit[]
}

model District {
  id        Int    @id @default(autoincrement())
  name      String @unique
  maxAgents Int    @default(4)

  agents Agent[]
}

model RefreshToken {
  id        Int      @id @default(autoincrement())
  userId    Int
  token     String   @unique
  expiresAt DateTime
  isRevoked Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model AgentTypeProduct {
  agentTypeId Int
  productId   Int

  agentType AgentType @relation(fields: [agentTypeId], references: [id], onDelete: Cascade)
  product   Product   @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@id([agentTypeId, productId])
}

model ProductUnit {
  productId Int
  unitId    Int

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  unit    Unit    @relation(fields: [unitId], references: [id], onDelete: Cascade)

  @@id([productId, unitId])
}